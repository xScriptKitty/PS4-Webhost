
<html manifest="Cache.manifest">
<head>
<style>
    html, body{
margin:auto;
font-family:sans-serif;
font-size:20px;
font-weight:lighter;
text-align:left;
color:#FFFFFF;
background-size:cover;
}
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}
 .content {
  width:80%;
  height:15%;
  margin-left:7.5%;
  background:rgba(0,0,0,0.5);
  color:white;
  margin-top:1%;
  font-size:25px;
  text-align:center;
  border-radius:30px;
  padding:20px;
  line-height:12px;
  position:absolute;bottom:0px;
 }
 .title {
  font-size:40px;
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-weight:bolder;
  margin-bottom:10px;
 }
 .yellow {
  color:yellow;
 }
 .hue {
  color:yellow;
  padding:10px;
  border-radius:10px;
  animation:hue 5s linear infinite;
  -webkit-animation: hue 5s linear infinite;
  box-shadow: 0px 0px 50px yellow;
  color:white;
  background:rgba(255,255,0,0.4);
 }
 .hue:hover{
  color:yellow;
  background:transparent;
 }
 @keyframes hue{
 0%{
 filter:hue-rotate(0deg);
 -webkit-filter:hue-rotate(0deg);
 }
 10%{
 box-shadow: 0px 1px 50px yellow;
 }
 20%{
 box-shadow: 1px 1px 50px yellow;
 }
 30%{
 box-shadow: 1px 0px 50px yellow;
 }
 40%{
  box-shadow: 1px -1px 50px yellow;
 }
 50%{
 box-shadow: 0px -1px 50px yellow;
 }
 60%{
 box-shadow: -1px -1px 50px yellow;
 }
 70%{
 box-shadow: -1px 0px 50px yellow;
 }
 80%{
 box-shadow: -1px 1px 50px yellow;
 }
 90%{
 box-shadow: 0px 1px 50px yellow;
 }
 100%{
 filter:hue-rotate(360deg);
 -webkit-filter:hue-rotate(360deg);
 }
 }
 .text {
  padding-bottom:50px;
 }
  .back {
   font-size:25px;
   margin-top:10px;
   display:block;
   line-height:55px;
   width:20%;
   text-decoration:none;
   height:50px;
   background:white;
   color:black;
   border-radius:15px;
  }
  .back:hover{
   border:2px solid white;
   background:transparent;
   box-sizing:border-box;
   color:white;
  }
 #psip {
  text-align: center;
  margin-left: 38%;
  margin-right: auto;
  width:15%;
  display:flex;
  position: absolute;
  
  background: rgba(0, 0, 0, 0.500);
  border-radius: 2em;
  border: none;
  padding: 0.8em;
  
  color: #ffffff;
  padding-left: 1.5em;
  
  outline: none;
  box-shadow: 0 4px 6px -5px hsl(0, 0%, 40%), inset 0px 4px 6px -5px hsl(0, 0%, 2%);
  backdrop-filter: blur(5px);
}
/* Modal Content */
.modal-content {
  font-family: BFARNAZ;
  font-size: 18px;
  position: relative;
  background-color: #dddddd;
  margin: auto;
  padding: 0;
  border: 1px solid #888;
  width: 50%;
  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
  -webkit-animation-name: animatetop;
  -webkit-animation-duration: 0.4s;
  animation-name: animatetop;
  animation-duration: 0.4s
}
button {
            background:rgba(0,0,0,0.5);
			box-shadow: 0 5px 20px 0 white;
            border: 2px solid black;
            border-radius: 10px;
            width: 173px;
            height: 40px;            
            text-align: center;
}
button:hover {
            box-shadow: 0 5px 50px 0 white;
            color: white;
            border-radius: 10px;
			background-color: #0F0F53;
}

hr {
padding:0;
margin:0;
opacity:0.7;
}

#progress {
 font-weight:bold;
 text-shadow: 4px 4px 4px black;

 font-size:17px;
}

#PS4fw {
 font-weight:bold;
 text-shadow: 4px 4px 4px black;

 font-size:17px;
}
.pointer {cursor: pointer;}


    </style>
<meta charset="utf-8">
<title>Lost PS4 WebHost 11.00</title>
		<script>
			window.applicationCache.ondownloading=function(){document.getElementById("progress").innerHTML="Page Caching Started!!";};
			window.applicationCache.onprogress=function(a){document.getElementById("progress").innerHTML=(Math.round(100*(a.loaded/a.total)))+"%";};
			window.applicationCache.oncached=function(){document.getElementById("progress").innerHTML="Page Cached Successfully!!";setTimeout(function(){document.getElementById("progress").innerHTML="Reopen the Page !!"; }, 1500);};
		</script>
<script>

var payloadData = "";
var array = "";
var PLfile = "";
localStorage.setItem("ipaddress","127.0.0.1");

var getPayload=function(payload,onLoadEndCallback)
    {
		var req=new XMLHttpRequest();
		req.open('GET',payload);
		req.send();
		req.responseType="arraybuffer";
		req.onload=function(event){
			if(onLoadEndCallback)onLoadEndCallback(req,event);
		};
	};

var sendPayload=function(url,data,onLoadEndCallback)
    {
		var req=new XMLHttpRequest();
		req.open("POST",url,true);
		req.send(data);
		req.onload=function(event){
			if(onLoadEndCallback)onLoadEndCallback(req,event);
		};
	};

function checkservstatus()
{
    var req = new XMLHttpRequest(); 
	req.open("POST", "http://"+localStorage.ipaddress+":9090/status");
	req.send();
	req.onerror = function(){
		progress.innerHTML="GoldHEN BinServer Not Detected!!!";
		sessionStorage.isbinserver = "no";
	};
	req.onload = function(){
	var responseJson = JSON.parse(req.responseText);
	if (responseJson.status=="ready"){
		progress.innerHTML="GoldHEN BinServer Detected, Run Payloads :)";
		sessionStorage.isbinserver = "yes";
		}
	};
}

function GetPLbz2(PLfile)
{ //Loading Payload via Payload Param.
	   // First do an initial check to see if the BinLoader server is running, ready or busy.
	   var req = new XMLHttpRequest(); 
	   req.open("POST", "http://"+localStorage.ipaddress+":9090/status");
	   req.send();
	   req.onerror = function(){
		   alert("Cannot Load Payload Because The BinLoader Server Is Not Running");//<<If server is not running, alert message.
		   return;
	   };
		req.onload = function(){
			var responseJson = JSON.parse(req.responseText);
			if (responseJson.status=="ready"){
		    getPayload(PLfile, function (req) {
            if ((req.status === 200 || req.status === 304) && req.response) {
				   //Sending bins via IP POST Method
                    let payloadData = new Uint8Array(req.response); //Method By Hippie68
                   // Decompress
                   if (PLfile.endsWith(".bz2"))
                   {
                   try {
                    payloadData = bzip2.simple(bzip2.array(payloadData));
                   } catch (error) {
                   throw error;
                   }
                   }
                   //Send Decompress Payload to GoldHEN Bin Server
					sendPayload("http://" + localStorage.ipaddress + ":9090", payloadData.buffer, function (req) {
					   if (req.status === 200) {
						allset();
					   }else{progress.innerHTML= 'Cannot send payload';return;}
					})
				}
			});
			}
			else {
				alert("Cannot Load Payload Because The BinLoader Server Is Busy");//<<If server is busy, alert message.
				return;
			}
		};
	}

function load_poc(){
 var req = new XMLHttpRequest();
 req.responseType = "arraybuffer";
 req.open('GET', PLfile);
 req.send();
 req.onreadystatechange = function () {
  if (req.readyState == 4) {
   PLD = req.response;
   var payload_buffer = chain.syscall(477, 0, PLD.byteLength*4 , 7, 0x1002, -1, 0);
   var pl = p.array_from_address(payload_buffer, PLD.byteLength*4);
   var padding = new Uint8Array(4 - (req.response.byteLength % 4) % 4);
   var tmp = new Uint8Array(req.response.byteLength + padding.byteLength);
   tmp.set(new Uint8Array(req.response), 0);
   tmp.set(padding, req.response.byteLength);
   var shellcode = new Uint32Array(tmp.buffer);
   pl.set(shellcode,0);
   var pthread = p.malloc(0x10);
   chain.call(libKernelBase.add32(OFFSET_lk_pthread_create), pthread, 0x0, payload_buffer, 0);
   goldset();
  }
 };
}

function GetPL(PLfile){
 var req = new XMLHttpRequest(); 
	   req.open("POST", "http://"+localStorage.ipaddress+":9090/status");
	   req.send();
	   req.onerror = function(){
		   alert("Cannot Load Payload Because The BinLoader Server Is Not Running");//<<If server is not running, alert message.
		   return;
	   };
		req.onload = function(){
			var responseJson = JSON.parse(req.responseText);
			if (responseJson.status=="ready"){
		    getPayload(PLfile, function (req) {
				if ((req.status === 200 || req.status === 304) && req.response) {
				   //Sending bins via IP POST Method
					sendPayload("http://" + localStorage.ipaddress + ":9090", req.response, function (req) {
					   if (req.status === 200) {
						allset();
					   }else{progress.innerHTML= 'Cannot send payload';return;}
					})
				}
			});
			}
			else {
				alert("Cannot Load Payload Because The BinLoader Server Is Busy");//<<If server is busy, alert message.
				return;
			}
		};
}

function allset() {
window.progress.innerHTML="Payload loaded";
}

function goldset() {
window.progress.innerHTML="GoldHEN loaded";
}

function goldhen(){
    progress.innerHTML="Goldhen loading... please wait";
    PLfile = "goldhen2b.bin";
    setTimeout(poc, 500); 
}

function goldhen2(){
    progress.innerHTML="Goldhen 2.0b2 loading... please wait";
    PLfile = "goldhen2b2.bin";
    setTimeout(poc, 500); 
}
function goldhen212(){
    progress.innerHTML="Goldhen 2.1.2 loading... please wait";
    PLfile = "goldhen_212_1100.bin";
    setTimeout(poc, 500); 
}
function goldhen224(){
    progress.innerHTML="Goldhen 2.2.4 loading... please wait";
    PLfile = "goldhen_2.2.4_1100.bin";
    setTimeout(poc, 500); 
}
function goldhen23(){
    progress.innerHTML="Goldhen 2.3 loading... please wait";
    PLfile = "goldhen_2.3_1100.bin";
    setTimeout(poc, 500); 
}
</script>

</head>
<body onload="checkservstatus()" style='background-color:#1A1920'>
<h1 style='text-shadow: 4px 4px 4px black;font-size:30px;text-align:center;text-shadow: 4px 4px 4px black;color:yellow;'>Lost PS4 WebHost 11.00</h1>
<h1 id=progress style='font-size:25px;text-align:center;text-shadow: 4px 4px 4px black;color:white;'>Status</h1>
<div id=all style="text-align:center">
<button style='font-size:20px;text-align:center;background-color:blue;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='WebRTE to hook game memory'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_WebRTE()"> WebRTE </button>
<button style='font-size:20px;text-align:center;background-color:green;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='PS4Debug'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_PS4Debug()"> Ps4debug </button>
<br><br>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Unlocks some debug features available on testkit'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_ToDexE()"> ToDex Enable </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Return to normal'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_ToDexD()"> ToDex Disable </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Disable the auto opening of the last page used in the PS4 WebBrowser'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_HistoryBlocker()"> History Blocker </button>
<br><br>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Kernel dumper'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_KernelDumper()"> Kernel Dumper </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Module dumper'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_ModuleDumper()"> Module Dumper </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Creates dummy files in the PS4 update folder'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_DisableUpdates()">Disable Updates</button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Removes the dummy files in the PS4 update folder'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_EnableUpdates()"> Enable Update </button>
<br><br>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Dump Games only to a USB drive'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_DumperG()"> Dumper Game </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Dump Games Update only to a USB drive'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_DumperU()"> Dumper Update </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Create a backup of important database files and User Data'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_BackupDB()"> DB Backup </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Restore a backup of the database files and User Data'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_RestoreDB()"> DB Restore </button>
<br><br>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="pointer" onMouseOver="progress.innerHTML='Trainers'" onmouseout="progress.innerHTML='Status'" onclick="alllinux(); return false"> Trainers </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Fan Control'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_FAN()"> Fan Control </button><select style='font-size:20px;text-align:center;color:black' id="tempC"></select><a style='font-size:17px;text-align:center;color:white;'>&#176;C</a>
<br>
</div>
<div id=Linuxs style="text-align:center;display:none">
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="pointer" onMouseOver="msgs.innerHTML='back to base menu'" onmouseout="msgs.innerHTML='Lost PS4 WebHost 11.00'" onclick="backall(); return false"> Back to Menu </button>
<br><br>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Linux Loader VRAM 1GB ported to 11.00 by EinTim23'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_ELinux1gb()"> Linux 1GB </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Linux Loader VRAM 2GB ported to 11.00 by EinTim23'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_ELinux2gb()"> Linux 2GB </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Linux Loader VRAM 3GB ported to 11.00 by EinTim23'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_ELinux3gb()"> Linux 3GB </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Linux Loader VRAM 4GB ported to 11.00 by EinTim23'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_ELinux4gb()"> Linux 4GB </button>
<br><br>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Linux Loader VRAM 1GB ported to 11.00 by Karo'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_Linux1gb()"> Linux 1G </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Linux Loader VRAM 2GB ported to 11.00 by Karo'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_Linux2gb()"> Linux 2G </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Linux Loader VRAM 3GB ported to 11.00 by Karo'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_Linux3gb()"> Linux 3G </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Linux Loader VRAM 4GB ported to 11.00 by Karo'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_Linux4gb()"> Linux 4G </button>
<br><br><br>
</div>
<div id=Tools style="text-align:center;display:none">
</div>
<div id=Dumpers style="text-align:center;display:none">
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="pointer" onMouseOver="msgs.innerHTML='back to base menu'" onmouseout="msgs.innerHTML='Lost PS4 WebHost 11.00'" onclick="backall(); return false"> Back to Menu </button>
<br><br>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Dump Games only to a USB drive'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_DumperG()"> Dumper Game </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='Dump Games Update only to a USB drive'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_DumperU()"> Dumper Update </button>
<br><br>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='kernel dumper'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_KernelDumper()"> Kernel Dumper </button>
<button style='font-size:20px;text-align:center;text-shadow: 4px 4px 4px black;color:white' class="button" id="button-Payload" onMouseOver="progress.innerHTML='module dumper'" onmouseout="progress.innerHTML='Status'" type="button" onclick="load_ModuleDumper()"> Module Dumper </button>
<br><br><br>
</div>
<script>
    var UA = navigator.userAgent.substring(navigator.userAgent.indexOf('5.0 (') + 19, navigator.userAgent.indexOf(') Apple')).replace("layStation 4/","");
    if (UA == "11.00"){PS4fw.innerHTML="v"+UA+" Detected"};if(UA != "11.00"){PS4fw.innerHTML="Spoofed To v"+UA};
</script>
<script>

function load_PS4Debug(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "ps4debug.bin";
    GetPL(PLfile);
}

function load_BackupDB(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "backupdb.bin";
    GetPL(PLfile);
}

function load_pkgb(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "pkg-backup.bin";
    GetPL(PLfile);
}

function load_DumperG(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "DumperG.bin";
    GetPL(PLfile);
}

function load_DumperU(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "DumperU.bin";
    GetPL(PLfile);
}

function load_KernelDumper(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "kernel-dumper.bin";
    GetPL(PLfile);
}

function load_ModuleDumper(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "moduledumper.bin";
    GetPL(PLfile);
}

function load_RestoreDB(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "restoredb.bin";
    GetPL(PLfile);
}

function load_DisableUpdates(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "disableupdates.bin";
    GetPL(PLfile);
}

function load_EnableUpdates(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "enableupdates.bin";
    GetPL(PLfile);
}
  
function load_HistoryBlocker(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "historyblocker.bin";
    GetPL(PLfile);
}

function load_ToDexE(){
    progress.innerHTML="ToDEX Enabling... please wait";
    PLfile = "todex-enable.bin";
    GetPL(PLfile);
}

function load_ToDexD(){
    progress.innerHTML="ToDEX Disabling... please wait";
    PLfile = "todex-disable.bin";
    GetPL(PLfile);
}

function load_WebRTE(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "https://xscriptkitty.github.io/PS4-Webhost/WebRTE.bin";
    GetPL(PLfile);
}

function load_FAN(){
    progress.innerHTML="Payload sending... please wait";
    PLfile = "fan"+tempC.value+".bin";
    GetPL(PLfile);
}

function allmods(){
all.style.display = "none";
gtav.style.display = "block";
		}
function alldumpers(){
all.style.display = "none";
Dumpers.style.display = "block";
		}
function alllinux(){
all.style.display = "none";
Linuxs.style.display = "block";
		}
function alltools(){
all.style.display = "none";
Tools.style.display = "block";
		}
function backall(){
all.style.display = "block";
gtav.style.display = "none";
Linuxs.style.display = "none";
Dumpers.style.display = "none";
Tools.style.display = "none";
		}
</script>
<script>localStorage.setItem('fanthreshold', tempC.value);
for(var i=50; i<=80; i=i+5){
    var select = document.getElementById("tempC");
    var option = document.createElement("OPTION");
	select.options.add(option);
	option.text = i;
	option.value = i;
}
tempC.value=60;
</script>
<script>
//MODDED BY HIPPIE BZIP2.JS
var bzip2 = {};

bzip2.array = function(bytes) {
  var bit = 0, byte = 0;
  var BITMASK = [0, 0x01, 0x03, 0x07, 0x0F, 0x1F, 0x3F, 0x7F, 0xFF];
  return function(n) {
    var result = 0;
    while (n > 0) {
      var left = 8 - bit;
      if (n >= left) {
        result <<= left;
        result |= (BITMASK[left] & bytes[byte++]);
        bit = 0;
        n -= left;
      } else {
        result <<= n;
        result |= ((bytes[byte] & (BITMASK[n] << (8 - n - bit))) >> (8 - n - bit));
        bit += n;
        n = 0;
      }
    }
    return result;
  }
};

bzip2.simple = function(bits) {
  var size = bzip2.header(bits);
  var all = [], chunk = [];
  do {
    all = all.concat(chunk);
    chunk = bzip2.decompress(bits, size);
  } while (chunk != -1);
  return Uint8Array.from(all);
};

bzip2.header = function(bits) {
  if (bits(8 * 3) != 4348520) throw "No magic number found.";
  var i = bits(8) - 48;
  if (i < 1 || i > 9) throw "Not a bzip2 archive.";
  return i;
};

// Param1: a function for reading the block data (starting with 0x314159265359)
// Param2: block size (0-9) (optional, defaults to 9)
// Param3: length at which to stop decompressing and return the output
bzip2.decompress = function(bits, size, len) {
  var MAX_HUFCODE_BITS = 20;
  var MAX_SYMBOLS = 258;
  var SYMBOL_RUNA = 0;
  var SYMBOL_RUNB = 1;
  var GROUP_SIZE = 50;

  var bufsize = 100000 * size;
  for (var h = "", i = 0; i < 6; i++) h += bits(8).toString(16);
  if (h == "177245385090") return -1; // Last block
  if (h != "314159265359") throw "Not valid bzip2 data.";
  bits(32); // Ignore CRC codes
  if (bits(1)) throw "Unsupported obsolete version.";
  var origPtr = bits(24);
  if(origPtr > bufsize) throw "Initial position larger than buffer size.";
  var t = bits(16);
  var symToByte = new Uint8Array(256),
      symTotal = 0;
  for (i = 0; i < 16; i++) {
    if (t & (1 << (15 - i))) {
      var k = bits(16);
      for (j = 0; j < 16; j++) {
        if (k & (1 << (15 - j))) {
          symToByte[symTotal++] = (16 * i) + j;
        }
      }
    }
  }

  var groupCount = bits(3);
  if (groupCount < 2 || groupCount > 6) throw "Error 1 while decompressing.";
  var nSelectors = bits(15);
  if (nSelectors == 0) throw "Error 2 while decompressing.";
  var mtfSymbol = []; // TODO: possibly replace JS array with typed arrays
  for (var i = 0; i < groupCount; i++) mtfSymbol[i] = i;
  var selectors = new Uint8Array(32768);

  for (var i = 0; i < nSelectors; i++) {
    for (var j = 0; bits(1); j++) if (j >= groupCount) throw "Error 3 while decompressing.";
    var uc = mtfSymbol[j];
    mtfSymbol.splice(j, 1); // This is a probably inefficient MTF transform
    mtfSymbol.splice(0, 0, uc);
    selectors[i] = uc;
  }

  var symCount = symTotal + 2;
  var groups = [];
  for (var j = 0; j < groupCount; j++) {
    var length = new Uint8Array(MAX_SYMBOLS),
        temp = new Uint8Array(MAX_HUFCODE_BITS + 1);
    t = bits(5); // Lengths
    for (var i = 0; i < symCount; i++) {
      while (true) {
        if (t < 1 || t > MAX_HUFCODE_BITS) throw "Error 4 while decompressing.";
        if (!bits(1)) break;
        if (!bits(1)) t++;
        else t--;
      }
      length[i] = t;
    }
    var  minLen,  maxLen;
    minLen = maxLen = length[0];
    for (var i = 1; i < symCount; i++) {
      if (length[i] > maxLen) maxLen = length[i];
      else if (length[i] < minLen) minLen = length[i];
    }
    var hufGroup;
    hufGroup = groups[j] = {};
    hufGroup.permute = new Uint32Array(MAX_SYMBOLS);
    hufGroup.limit = new Uint32Array(MAX_HUFCODE_BITS + 1);
    hufGroup.base = new Uint32Array(MAX_HUFCODE_BITS + 1);
    hufGroup.minLen = minLen;
    hufGroup.maxLen = maxLen;
    var base = hufGroup.base.subarray(1);
    var limit = hufGroup.limit.subarray(1);
    var pp = 0;
    for (var i = minLen; i <= maxLen; i++)
      for (var t = 0; t < symCount; t++)
      if (length[t] == i) hufGroup.permute[pp++] = t;
      for (i = minLen; i <= maxLen; i++) temp[i] = limit[i] = 0;
      for (i = 0; i < symCount; i++) temp[length[i]]++;
      pp = t = 0;
      for (i = minLen; i < maxLen; i++) {
        pp += temp[i];
        limit[i] = pp - 1;
        pp <<= 1;
        base[i + 1] = pp - (t += temp[i]);
      }
      limit[maxLen] = pp + temp[maxLen] - 1;
      base[minLen] = 0;
  }
  var byteCount = new Uint32Array(256);
  for (var i = 0; i < 256; i++) mtfSymbol[i] = i;
  var runPos, count, symCount, selector;
  runPos = count = symCount = selector = 0;
  var buf = new Uint32Array(bufsize);
  while (true) {
    if (!(symCount--)) {
      symCount = GROUP_SIZE - 1;
      if (selector >= nSelectors) throw "Error 5 while decompressing.";
      hufGroup = groups[selectors[selector++]];
      base = hufGroup.base.subarray(1);
      limit = hufGroup.limit.subarray(1);
    }
    i = hufGroup.minLen;
    j = bits(i);
    while (true) {
      if (i > hufGroup.maxLen) throw "Error 6 while decompressing.";
      if (j <= limit[i]) break;
      i++;
      j = (j << 1) | bits(1);
    }
    j -= base[i];
    if (j < 0 || j >= MAX_SYMBOLS) throw "Error 7 while decompressing.";
    var nextSym = hufGroup.permute[j];
    if (nextSym == SYMBOL_RUNA || nextSym == SYMBOL_RUNB) {
      if (!runPos) {
        runPos = 1;
        t = 0;
      }
      if (nextSym == SYMBOL_RUNA) t += runPos;
      else t += 2 * runPos;
      runPos <<= 1;
      continue;
    }
    if (runPos) {
      runPos = 0;
      if (count + t >= bufsize) throw "Error 8 while decompressing.";
      uc = symToByte[mtfSymbol[0]];
      byteCount[uc] += t;
      while (t--) buf[count++] = uc;
    }
    if (nextSym > symTotal) break;
    if (count >= bufsize) throw "Error 9 while decompressing.";
    i = nextSym -1;
    uc = mtfSymbol[i];
    mtfSymbol.splice(i, 1);
    mtfSymbol.splice(0, 0, uc);
    uc = symToByte[uc];
    byteCount[uc]++;
    buf[count++] = uc;
  }
  if (origPtr < 0 || origPtr >= count) throw "Error 10 while decompressing.";
  var j = 0;
  for (var i = 0; i < 256; i++) {
    k = j + byteCount[i];
    byteCount[i] = j;
    j = k;
  }
  for (var i = 0; i < count; i++) {
    uc = buf[i] & 0xff;
    buf[byteCount[uc]] |= (i << 8);
    byteCount[uc]++;
  }
  var pos = 0, current = 0, run = 0;
  if (count) {
    pos = buf[origPtr];
    current = (pos & 0xff);
    pos >>= 8;
    run = -1;
  }
  count = count;
  var output = [];
  var copies, previous, outbyte;
  if (!len) len = Infinity;
  while (count) {
    count--;
    previous = current;
    pos = buf[pos];
    current = pos & 0xff;
    pos >>= 8;
    if (run++ == 3) {
      copies = current;
      outbyte = previous;
      current = -1;
    } else {
      copies = 1;
      outbyte = current;
    }
    while (copies--) {
      output.push(outbyte);
      if (!--len) return output;
    }
    if (current != previous) run = 0;
  }
  return output;
};

</script>

</body>

</html>
